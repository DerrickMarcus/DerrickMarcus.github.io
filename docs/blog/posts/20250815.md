---
date: 2025-08-15
categories:
- research
- robot
---

# YOLO 检测目标坐标估算

> 书接上回：在 [Research - Camera Calibration](../../research/robot/camera_calibration.md) 中，我们探讨了一个实际的工程问题：一个装有单目相机的 SLAM 小车系统，在已知车体相对于 map 系下的位姿、相机相对于车体的外参、相机图像经过 YOLO 检测目标之后，推算出检测到目标的实际坐标（map 系下坐标，或车体坐标）？在之前的解答中，我们使用了非常直接的求解方法，但是在实际测试中发现，效果不是很理想。另外，从理论上来说，单次求解使用的帧数越多，结果越稳定，但是由于多个帧的方程是叠加起来的，帧数越多维数越大，求解速度会变慢。因此，本博客尝试使用另外一种方法：射线法，试图得到更加稳定的解。

<!-- more -->

假设：

1. 图像通过 YOLO 模型，得到检测框，以检测框中心像素坐标 $(u,v)$ 作为检测目标物位置。
2. 去畸变后，相机内参矩阵为 $\mathbf{K}\in\mathbb{R}^{3\times 3}$ ，车体到相机的静态外参为 ${}_L^C\mathbf{T}\in\mathbb{R}^{4\times 4}$ .
3. 从里程计消息中，提取出车体到世界系的位姿变换 ${}_L^W\mathbf{T}\in\mathbb{R}^{4\times 4}$ .
4. 检测目标物在世界系中静止不动，在世界系、车体系、相机系中的坐标分别为 $\mathbf{X}_W,\mathbf{X}_L,\mathbf{X}_C$ . 我们需要先求解 $\mathbf{X}_W$ ，因为它是常数，然后可以变换到车体系中用于可视化。

首先，目标物从像素系到相机系的变换为：

$$
Z_C\begin{pmatrix}
u \\ v \\1
\end{pmatrix}=\mathbf{K}\cdot\mathbf{X}_C=\mathbf{K}\begin{pmatrix}
X_C \\ Y_C \\ Z_C
\end{pmatrix}
$$

忽略系数 $Z_C$ ，得到 $\mathbf{X}_C=\mathbf{K}^{-1}\cdot[u,v,1]^T$ ，因为我们不关心它的模长，只关心它所在的射线起点为相机系原点（光心），经过目标物。对其归一化得到该射线方向的单位向量：

$$
\mathbf{d}_C=\frac{\mathbf{K}^{-1}\cdot[u,v,1]^T}{\|\mathbf{K}^{-1}\cdot[u,v,1]^T\|}
$$

然后计算相机系到世界系的位姿变换：

$$
{}_C^W\mathbf{T}={}_L^W\mathbf{T} \cdot {}_C^L\mathbf{T}={}_L^W\mathbf{T} \cdot \left({}_L^C\mathbf{T}\right)^{-1}
$$

为避免矩阵求逆，我们直接写出 ${}_C^W\mathbf{T}$ 的表达式：

$$
\begin{gather*}
{}_C^W\mathbf{T}=\begin{pmatrix}
\mathbf{R}_{CW} & \mathbf{t}_{CW} \\
\mathbf{0} & 1
\end{pmatrix},\quad
{}_L^W\mathbf{T}=\begin{pmatrix}
\mathbf{R}_{LW} & \mathbf{t}_{LW} \\
\mathbf{0} & 1
\end{pmatrix},\quad
{}_L^C\mathbf{T}=\begin{pmatrix}
\mathbf{R}_{LC} & \mathbf{t}_{LC} \\
\mathbf{0} & 1
\end{pmatrix},
\\ \mathbf{R}_{CW}=\mathbf{R}_{LW}\left(\mathbf{R}_{LC}\right)^T,\quad \mathbf{t}_{CW}=\mathbf{t}_{LW}-\mathbf{R}_{CW}\mathbf{t}_{LC}
\end{gather*}
$$

然后把单位方向向量变换到世界系： $\mathbf{d}_W=\mathbf{R}_{CW}\mathbf{d}_C$ ，同时，相机的光心坐标即为平移向量 $\mathbf{C}_W=\mathbf{t}_{CW}$ .

因此，在世界系下，一帧图像+位姿，对应一条“以相机光心为起点，经过目标物的射线”，即 $\mathbf{C}_W+\lambda\mathbf{d}_W,\;\lambda>0$ .

在相机随车体运动过程中，每一帧都对应一条这样的射线，理论上这些射线相交于同一点，也就是目标点所在位置 $\mathbf{X}_W$ . 实际中由于噪声和误差的存在，这些若干条射线可能有多个交点，因此使用最小二乘法求最优解。

对于世界系下的任意一点 $\mathbf{X}$ ，若以射线上的某一点为起点，以该点 $\mathbf{X}$ 为终点组成的向量，可以表示为 $\mathbf{X}-\mathbf{C}$ ，该向量在射线上投影对应的向量为 $\mathbf{d}_W\mathbf{d}_W^T(\mathbf{X}-\mathbf{C})$ （因为 $\mathbf{d}_W$ 也是单位向量），因此点 $\mathbf{X}$ 到射线的最短距离向量，即为残差 $\mathbf{r}$ ：

$$
\mathbf{r}=(\mathbf{X}-\mathbf{C})-\mathbf{d}_W\mathbf{d}_W^T(\mathbf{X}-\mathbf{C})=(\mathbf{I}-\mathbf{d}_W\mathbf{d}_W^T)(\mathbf{X}-\mathbf{C})
$$

因此，点 $\mathbf{X}$ 到射线上的最短距离即为残差的模长 $\|\mathbf{r}\|$ . 令 $\mathbf{P}=\mathbf{I}-\mathbf{d}_W\mathbf{d}_W^T$ ，有 $\mathbf{P}^T\mathbf{P}=\mathbf{P}$ .

$$
\|\mathbf{r}\|^2=(\mathbf{X}-\mathbf{C})^T\mathbf{P}^T\mathbf{P}(\mathbf{X}-\mathbf{C})=(\mathbf{X}-\mathbf{C})^T\mathbf{P}(\mathbf{X}-\mathbf{C})
$$

我们希望求解出来的坐标 $\mathbf{X}_W$ 到各条直线的距离之和最小，写为加权最小二乘形式：

$$
L(\mathbf{X})=\sum_i w_i\|\mathbf{r}_i\|^2
$$

转换为求解方程：

$$
\frac{\partial L}{\partial \mathbf{X}}=2\sum_i w_i\mathbf P_i(\mathbf X-\mathbf C_i)=0 \implies
\left(\sum_i w_i\mathbf P_i\right)\mathbf X=\sum_i w_i\mathbf P_i\mathbf C_i
$$

初始时刻设置 $\mathbf{A}=\mathbf{0},\mathbf{b}=\mathbf{0}$ . 在求解过程中，我们需要逐个构造 $\mathbf{P}_i,\mathbf{C}_i$ 并加入已有的 $\mathbf{A},\mathbf{b}$ ，最终求解 $\mathbf{A}\mathbf{X}=\mathbf{b}$ 可得到目标物的世界系坐标 $\mathbf{X}_W$ ，可以再变换到车体系 $\mathbf{X}_L={}_W^L\mathbf{T}\cdot\mathbf{X}_W=(\mathbf{R}_{LW})^T(\mathbf{X}_W-\mathbf{t}_{LW})$ ，方便进行可视化。

存在的问题：

1. 当车体自身纯旋转时，也就是相机光心不动（在相机和车体位于同一竖直方向时），此时即使是多帧图像和位姿，它们对应的也是同一个射线。
2. 当车体只前进，尤其是当目标物接近图像中心时，也就是相机光心几乎向着目标物前进，此时多帧图像和位姿对应的也是同一条射线。
