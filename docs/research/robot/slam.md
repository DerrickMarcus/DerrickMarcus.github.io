# SLAM

五项关键技术：全局地图，自身定位，路径规划，运动控制，环境感知。

## 导航介绍

全局地图：

在现实生活中，当我们需要实现导航时，可能会首先参考一张全局性质的地图，然后根据地图来确定自身的位置、目的地位置，并且也会根据地图显示来规划一条大致的路线……对于机器人导航而言，也是如此，在机器人导航中地图是一个重要的组成元素，当然如果要使用地图，首先需要绘制地图。关于地图建模技术不断涌现，这其中有一门称之为 SLAM 的理论脱颖而出:

SLAM (simultaneous localization and mapping)，也称为 CML (Concurrent Mapping and Localization), 即时定位与地图构建，或并发建图与定位。SLAM问题可以描述为: 机器人在未知环境中从一个未知位置开始移动,在移动过程中根据位置估计和地图进行自身定位，同时在自身定位的基础上建造增量式地图，以绘制出外部环境的完全地图。

在 ROS 中，较为常用的 SLAM 实现也比较多，比如: gmapping, hector_slam, cartographer, rgbdslam, ORB_SLAM ...

如果要完成 SLAM ，机器人必须要具备感知外界环境的能力，尤其是要具备获取周围环境深度信息的能力。感知的实现需要依赖于传感器，比如: 激光雷达、摄像头、RGB-D 摄像头...

SLAM 可以用于地图生成，而生成的地图还需要被保存以待后续使用，在 ROS 中保存地图的功能包是 map_server。

另外注意: SLAM 虽然是机器人导航的重要技术之一，但是 二者并不等价。确切的讲，SLAM 只是实现地图构建和即时定位。

自身定位：

导航伊始和导航过程中，机器人都需要确定当前自身的位置，如果在室外，那么 GPS 是一个不错的选择，而如果室内、隧道、地下或一些特殊的屏蔽 GPS 信号的区域，由于 GPS 信号弱化甚至完全不可用，那么就必须另辟蹊径了，比如前面的 SLAM 就可以实现自身定位，除此之外，ROS 中还提供了一个用于定位的功能包：amcl。

amcl (adaptive Monte Carlo Localization)自适应的蒙特卡洛定位,是用于 2D 移动机器人的概率定位系统。它实现了自适应（或 KLD 采样）蒙特卡洛定位方法，该方法使用粒子过滤器根据已知地图跟踪机器人的姿态。

路径规划：

导航就是机器人从 A 点运动至 B 点的过程，在这一过程中，机器人需要根据目标位置计算全局运动路线，并且在运动过程中，还需要时时根据出现的一些动态障碍物调整运动路线，直至到达目标点，该过程就称之为路径规划。在 ROS 中提供了 move_base 包来实现路径规则，该功能包主要由两大规划器组成:

全局路径规划(gloable_planner)

根据给定的目标点和全局地图实现总体的路径规划，使用 Dijkstra 或 A* 算法进行全局路径规划，计算最优路线，作为全局路线。

本地时时规划(local_planner)

在实际导航过程中，机器人可能无法按照给定的全局最优路线运行，比如：机器人在运行中，可能会随时出现一定的障碍物。本地规划的作用就是使用一定算法(Dynamic Window Approaches) 来实现障碍物的规避，并选取当前最优路径以尽量符合全局最优路径

全局路径规划与本地路径规划是相对的，全局路径规划侧重于全局、宏观实现，而本地路径规划侧重与当前、微观实现。

运动控制

导航功能包集假定它可以通过话题 `cmd_vel` 发布 `geometry_msgs/Twist` 类型的消息，这个消息基于机器人的基座坐标系，它传递的是运动命令。这意味着必须有一个节点订阅 `cmd_vel` 话题， 将该话题上的速度命令转换为电机命令并发送。

环境感知

感知周围环境信息，比如: 摄像头、激光雷达、编码器...，摄像头、激光雷达可以用于感知外界环境的深度信息，编码器可以感知电机的转速信息，进而可以获取速度信息并生成里程计信息。

在导航功能包集中，环境感知也是一重要模块实现，它为其他模块提供了支持。其他模块诸如: SLAM、amcl、move_base 都需要依赖于环境感知。

## 坐标系

通过里程计定位：时时收集机器人的速度信息计算并发布机器人坐标系与父级参考系的相对关系。

通过传感器定位：通过传感器收集外界环境信息通过匹配计算并发布机器人坐标系与父级参考系的相对关系。

通常两者结合使用。

上述两种定位实现中，机器人坐标系一般使用机器人模型中的根坐标系(base_link 或 base_footprint)，里程计定位时，父级坐标系一般称之为 odom，如果通过传感器定位，父级参考系一般称之为 map。当二者结合使用时，map 和 odom 都是机器人模型根坐标系的父级，这是不符合坐标变换中"单继承"的原则的，所以，一般会将转换关系设置为: map → doom → base_link / base_footprint。

## 闭环检测

闭环检测/回环检测，SLAM 系统检测到当前回到了曾经的一个位置，进行地图的全局优化，将当前的地图与全局地图做匹配，消除累积误差（如漂移）。

通常，我们采取前端提取特征点、轨迹和地图初值，后端进行数据优化的建图方法。如果仅使用里程计，仅考虑相邻时间上的关键帧，前端只给出局部的位姿约束，那么误差将会逐渐累积，长期建图的结果会变得不可靠，无法得到全局一致的轨迹和地图。

闭环检测模块可以认为是前端和后端之外独立的一个模块，可以给出时间间隔更加久远的约束，从而能够消除累计误差。

## 关键帧融合

在建图过程中，将多个关键帧的信息（点云或者图像）进行空间对齐和融合，得到一个更高质量、更稠密、更精确的地图。

例如当机器人在场景中缓慢移动或者拍摄多个相邻视角的图像时，得到大量相似且冗余的帧，如果每一帧都单独用来建图会浪费计算资源，而关键帧融合可以将这些冗余的帧合并为一个稠密点云或者一个更加清晰的全景地图。

常见的关键帧融合方式：点云配准、图像拼接等。
